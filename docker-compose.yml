services:
    db:
        image: postgres:16-alpine
        container_name: hatchup-db
        environment:
            POSTGRES_DB: ${DB_NAME:-hatchup}
            POSTGRES_USER: ${DB_USER:-postgres}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - '${DB_PUBLISHED_PORT:-15432}:5432'
        healthcheck:
            test:
                ['CMD-SHELL', 'pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        restart: unless-stopped

    redis:
        image: redis:7-alpine
        container_name: hatchup-redis
        ports:
            - '${REDIS_PUBLISHED_PORT:-16379}:6379'
        volumes:
            - redis_data:/data
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    rustfs:
        image: rustfs/rustfs:latest
        container_name: hatchup-rustfs
        environment:
            RUSTFS_ACCESS_KEY: ${RUSTFS_ACCESS_KEY:-rustfsadmin}
            RUSTFS_SECRET_KEY: ${RUSTFS_SECRET_KEY:-rustfsadmin}
            RUSTFS_CONSOLE_ENABLE: 'true'
        volumes:
            - rustfs_data:/data
        ports:
            - '19000:9000'
            - '19001:9001'
        command: --console-enable /data
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9000/health/live']
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    web:
        build: .
        container_name: hatchup-web
        restart: unless-stopped
        working_dir: /app
        env_file:
            - .env
        environment:
            DB_HOST: db
            DB_PORT: '5432'
            DB_NAME: ${DB_NAME:-hatchup}
            DB_USER: ${DB_USER:-postgres}
            DB_PASSWORD: ${DB_PASSWORD:-postgres}
            RUSTFS_ENDPOINT: ${RUSTFS_ENDPOINT:-rustfs:9000}
            RUSTFS_ACCESS_KEY: ${RUSTFS_ACCESS_KEY:-rustfsadmin}
            RUSTFS_SECRET_KEY: ${RUSTFS_SECRET_KEY:-rustfsadmin}
            RUSTFS_BUCKET_NAME: ${RUSTFS_BUCKET_NAME:-hatchup}
            RUSTFS_REGION: ${RUSTFS_REGION:-us-east-1}
            RUSTFS_USE_HTTPS: ${RUSTFS_USE_HTTPS:-false}
            REDIS_URL: ${REDIS_URL:-redis://redis:6379/1}
        ports:
            - '${WEB_PORT:-8000}:8000'
        volumes:
            - .:/app
        depends_on:
            - db
            - redis
            - rustfs

volumes:
    postgres_data:
    rustfs_data:
    redis_data:
